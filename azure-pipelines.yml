trigger:
  batch: true
  branches:
    include:
      - main

pool: Avengers

jobs:
  - job: BuildAndDeploy
    displayName: Build and Deploy
    steps:
      - checkout: self
        clean: false

      - task: NodeTool@0
        inputs:
          versionSpec: '17.x'
        displayName: 'Install Node.js'

      - script: |
          bun install
        displayName: 'bun install'

      - script: |
          bun x ng build -c production --aot --build-optimizer --optimization
        displayName: 'ng build'

      # Deploy to Dev
      - task: PowerShell@2
        displayName: 'Dev - Clean Old Files'
        inputs:
          targetType: 'inline'
          script: |
            $deployPath = "C:\Server\Nginx\html-dev"

            if (Test-Path $deployPath) {
                Write-Host "Cleaning old files from: $deployPath"

                $patterns = @("main*.js", "polyfills*.js", "runtime*.js", "scripts*.js", "styles*.css")

                foreach ($pattern in $patterns) {
                    $files = Get-ChildItem -Path $deployPath -Filter $pattern -ErrorAction SilentlyContinue
                    foreach ($file in $files) {
                        Write-Host "Deleting: $($file.FullName)"
                        Remove-Item $file.FullName -Force
                    }
                }
            }

      - task: CopyFiles@2
        displayName: 'Dev - Copy Files'
        inputs:
          SourceFolder: 'dist'
          Contents: '**'
          TargetFolder: 'C:\Server\Nginx\html-dev'
          OverWrite: true

      - task: PowerShell@2
        displayName: 'Dev - Transform appSettings'
        inputs:
          targetType: 'inline'
          script: |
            $settingsPath = "C:\Server\Nginx\html-dev\appSettings.json"
            $settings = Get-Content $settingsPath | ConvertFrom-Json

            $settings.apiUrl = "$(Dev_apiUrl)"

            $settings | ConvertTo-Json -Depth 10 | Set-Content $settingsPath
            Write-Host "Dev appSettings.json updated"

      - task: PowerShell@2
        displayName: 'Dev - Increment Version'
        inputs:
          targetType: 'inline'
          script: |
            $apiUrl = "$(Dev_apiUrl)"
            $email = "$(adminEmail)"
            $password = "$(adminPassword)"

            Write-Host "Incrementing version via API..."

            try {
                $loginBody = @{ email = $email; password = $password } | ConvertTo-Json
                $loginResponse = Invoke-RestMethod -Uri "$apiUrl/login" -Method Post -Body $loginBody -ContentType "application/json"
                $token = $loginResponse.access_token

                if (-not $token) {
                    Write-Error "Failed to get access token"
                    exit 1
                }

                $headers = @{ Authorization = "Bearer $token" }
                $versionResponse = Invoke-RestMethod -Uri "$apiUrl/utility/version" -Method Put -Headers $headers
                Write-Host "Version incremented: $versionResponse"
            }
            catch {
                Write-Error "Failed to increment version: $_"
                exit 1
            }

      # Deploy to Production
      - task: PowerShell@2
        displayName: 'Prod - Clean Old Files'
        inputs:
          targetType: 'inline'
          script: |
            $deployPath = "C:\Server\Nginx\html"

            if (Test-Path $deployPath) {
                Write-Host "Cleaning old files from: $deployPath"

                $patterns = @("main*.js", "polyfills*.js", "runtime*.js", "scripts*.js", "styles*.css")

                foreach ($pattern in $patterns) {
                    $files = Get-ChildItem -Path $deployPath -Filter $pattern -ErrorAction SilentlyContinue
                    foreach ($file in $files) {
                        Write-Host "Deleting: $($file.FullName)"
                        Remove-Item $file.FullName -Force
                    }
                }
            }

      - task: CopyFiles@2
        displayName: 'Prod - Copy Files'
        inputs:
          SourceFolder: 'dist'
          Contents: '**'
          TargetFolder: 'C:\Server\Nginx\html'
          OverWrite: true

      - task: PowerShell@2
        displayName: 'Prod - Transform appSettings'
        inputs:
          targetType: 'inline'
          script: |
            $settingsPath = "C:\Server\Nginx\html\appSettings.json"
            $settings = Get-Content $settingsPath | ConvertFrom-Json

            $settings.apiUrl = "$(Prod_apiUrl)"

            $settings | ConvertTo-Json -Depth 10 | Set-Content $settingsPath
            Write-Host "Prod appSettings.json updated"

      - task: PowerShell@2
        displayName: 'Prod - Increment Version'
        inputs:
          targetType: 'inline'
          script: |
            $apiUrl = "$(Prod_apiUrl)"
            $email = "$(adminEmail)"
            $password = "$(adminPassword)"

            Write-Host "Incrementing version via API..."

            try {
                $loginBody = @{ email = $email; password = $password } | ConvertTo-Json
                $loginResponse = Invoke-RestMethod -Uri "$apiUrl/login" -Method Post -Body $loginBody -ContentType "application/json"
                $token = $loginResponse.access_token

                if (-not $token) {
                    Write-Error "Failed to get access token"
                    exit 1
                }

                $headers = @{ Authorization = "Bearer $token" }
                $versionResponse = Invoke-RestMethod -Uri "$apiUrl/utility/version" -Method Put -Headers $headers
                Write-Host "Version incremented: $versionResponse"
            }
            catch {
                Write-Error "Failed to increment version: $_"
                exit 1
            }
