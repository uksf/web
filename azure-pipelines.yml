trigger:
  batch: true
  branches:
    include:
      - main

pool: Avengers

variables:
  buildOutput: '$(Build.SourcesDirectory)\dist'

stages:
  - stage: Build
    displayName: Build
    jobs:
      - job: Build
        displayName: Build
        steps:
          - checkout: self
            clean: false

          - task: NodeTool@0
            inputs:
              versionSpec: '22.x'
            displayName: 'Install Node.js'

          - task: Cache@2
            inputs:
              key: 'bun | "$(Agent.OS)" | bun.lock'
              path: 'node_modules'
            displayName: 'Cache node_modules'

          - script: |
              bun install --frozen-lockfile
            displayName: 'bun install'

          - script: |
              bun run test
            displayName: 'Unit Tests'
            env:
              CI: 'true'

          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'test-results/junit.xml'
            condition: succeededOrFailed()

          - script: |
              bun run build-storybook
            displayName: 'Build Storybook'
            env:
              CI: 'true'

          - script: |
              npx playwright install chromium
            displayName: 'Install Playwright Browsers'

          - script: |
              bun run test:storybook
            displayName: 'Storybook Tests'
            env:
              CI: 'true'

          - task: PublishTestResults@2
            displayName: 'Publish Storybook Test Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'test-results/storybook-junit.xml'
              testRunTitle: 'Storybook Tests'
            condition: succeededOrFailed()

          - script: |
              bun x ng build -c production --aot --build-optimizer --optimization
            displayName: 'ng build'

  - template: templates/deploy-web.yml
    parameters:
      environment: Dev
      deployPath: 'C:\Server\Nginx\html-dev'
      apiUrl: 'https://api-dev.uk-sf.co.uk'
      variableGroup: UKSF Web - Dev
      dependsOn: Build

  - template: templates/deploy-web.yml
    parameters:
      environment: Prod
      deployPath: 'C:\Server\Nginx\html'
      apiUrl: 'https://api.uk-sf.co.uk'
      variableGroup: UKSF Web - Production
      dependsOn: DeployDev
