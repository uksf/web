@use 'styles/bootstrap-reset';
@use '@angular/material' as mat;
@use 'styles/theme-helpers' as th;
@use 'styles/form-field-theme' as fft;
@use 'styles/mat-form-field-overrides' as mffo;
@use 'styles/custom-theme-vars' as custom-vars;
@use 'app/features/command/components/command-ranks/ranks-list-item-layout' as ranks-layout;
@use 'app/features/operations/components/operations-servers/servers-list-item-layout' as servers-layout;

// Themes
@use 'darkTheme' as *;
//@use 'lightTheme' as *;

// Base
@use 'app/app.component.scss-theme' as *;
@use 'app/shared/components/teamspeak-connect/teamspeak-connect.component.scss-theme' as *;
@use 'app/core/components/footer-bar/footer-bar.component.scss-theme' as *;
@use 'app/core/components/header-bar/header-bar.component.scss-theme' as *;
@use 'app/core/components/notifications/notifications.component.scss-theme' as *;
@use 'app/core/components/side-bar/side-bar.component.scss-theme' as *;

// Pages
@use 'app/features/information/components/about-page/about-page.component.scss-theme' as *;
@use 'app/features/home/components/home-page/home-page.component.scss-theme' as *;
@use 'app/features/information/components/information-page/information-page.component.scss-theme' as *;
@use 'app/features/auth/components/login-page/login-page.component.scss-theme' as *;
@use 'app/features/modpack/modpack-page/modpack-page.component.scss-theme' as *;
@use 'app/features/application/components/application-page/application-page.component.scss-theme' as *;
@use 'app/features/operations/components/operations-page/operations-page.component.scss-theme' as *;
@use 'app/features/personnel/components/personnel-page/personnel-page.component.scss-theme' as *;
@use 'app/features/profile/components/profile-page/profile-page.component.scss-theme' as *;
@use 'app/features/recruitment/components/recruitment-application-page/recruitment-application-page.component.scss-theme' as *;
@use 'app/features/recruitment/components/recruitment-page/recruitment-page.component.scss-theme' as *;
@use 'app/features/units/components/unit-page/unit-page.component.scss-theme' as *;
@use 'app/features/units/components/units-page/units-page.component.scss-theme' as *;

// Components
@use 'app/features/admin/components/admin-servers/admin-servers.component.scss-theme' as *;
@use 'app/features/admin/components/admin-variables/admin-variables.component.scss-theme' as *;
@use 'app/shared/components/comment-display/comment-display.component.scss-theme' as *;
@use 'app/features/docs/components/docs-content/docs-content.component.scss-theme' as *;
@use 'app/features/docs/components/docs-content/docs-content.quill.scss-theme' as *;
@use 'app/features/docs/components/docs-permissions/docs-permissions.component.scss-theme' as *;
@use 'app/features/docs/components/docs-sidebar/docs-sidebar.component.scss-theme' as *;
@use 'app/features/docs/components/docs-sidebar/docs-folder/docs-folder.component.scss-theme' as *;
@use 'app/features/docs/components/docs-sidebar/docs-document/docs-document.component.scss-theme' as *;
@use 'app/shared/components/elements/file-drop/file-drop.component.scss-theme' as *;
@use 'app/shared/components/elements/inline-edit/inline-edit.component.scss-theme' as *;
@use 'app/shared/components/elements/inline-dropdown/inline-dropdown.component.scss-theme' as *;
@use 'app/shared/components/elements/loading-placeholder/loading-placeholder.component.scss-theme' as *;
@use 'app/shared/components/elements/selection-list/selection-list.component.scss-theme' as *;
@use 'app/shared/components/elements/theme-emitter/theme-emitter.component.scss-theme' as *;
@use 'app/features/command/components/command-requests/command-request.component.scss-theme' as *;
@use 'app/features/command/components/command-members/command-members.component.scss-theme' as *;
@use 'app/features/command/components/command-members/command-member-card/command-member-card.component.scss-theme' as *;
@use 'app/features/command/components/command-ranks/command-ranks.component.scss-theme' as *;
@use 'app/features/command/components/command-roles/command-roles.component.scss-theme' as *;
@use 'app/features/command/components/command-units/command-units.component.scss-theme' as *;
@use 'app/features/operations/components/operations-servers/operations-servers.component.scss-theme' as *;
@use 'app/features/personnel/components/personnel-discharges/personnel-discharges.component.scss-theme' as *;
@use 'app/features/personnel/components/personnel-loas-list/personnel-loas-list.component.scss-theme' as *;
@use 'app/features/personnel/components/personnel-roster/personnel-roster.component.scss-theme' as *;
@use 'app/features/units/components/units-orbat/units-orbat.component.scss-theme' as *;
@use 'app/features/units/components/units-orbat-aux/units-orbat-aux.component.scss-theme' as *;
@use 'app/features/units/components/units-orbat-secondary/units-orbat-secondary.component.scss-theme' as *;

// Modals
@use 'app/features/command/modals/add-unit-modal/add-unit-modal.component.scss-theme' as *;
@use 'app/features/operations/modals/edit-server-mods-modal/edit-server-mods-modal.component.scss-theme' as *;
@use 'app/shared/modals/request-loa-modal/request-loa-modal.component.scss-theme' as *;
@use 'app/shared/modals/message-modal/message-model.component.scss-theme' as *;
@use 'app/shared/modals/validation-report-modal/validation-report-modal.scss-theme' as *;

// Modpack
@use 'app/features/modpack/modpack-builds-dev/modpack-builds-dev.component.scss-theme' as *;
@use 'app/features/modpack/modpack-builds-rc/modpack-builds-rc.component.scss-theme' as *;
@use 'app/features/modpack/modpack-builds-steps/modpack-builds-steps.component.scss-theme' as *;
@use 'app/features/modpack/modpack-guide/modpack-guide.component.scss-theme' as *;
@use 'app/features/modpack/modpack-releases/modpack-releases.component.scss-theme' as *;
@use 'app/features/modpack/modpack-workshop/modpack-workshop.component.scss-theme' as *;
@use 'app/features/modpack/new-modpack-release-modal/new-modpack-release-modal.component.scss-theme' as *;
@use 'app/features/modpack/install-workshop-mod-modal/install-workshop-mod-modal.component.scss-theme' as *;
@use 'app/features/modpack/workshop-mod-intervention-modal/workshop-mod-intervention-modal.component.scss-theme' as *;

@import '@ali-hm/angular-tree-component/css/angular-tree-component.css';

// Add components themes
@mixin custom-components-theme($theme) {
    // Base
    @include app-component-theme($theme);
    @include connect-teamspeak-component-theme($theme);
    @include footer-bar-component-theme($theme);
    @include header-bar-component-theme($theme);
    @include notifications-component-theme($theme);
    @include side-bar-component-theme($theme);

    // Pages
    @include about-page-component-theme($theme);
    @include home-page-component-theme($theme);
    @include information-page-component-theme($theme);
    @include login-page-component-theme($theme);
    @include modpack-page-component-theme($theme);
    @include application-page-component-theme($theme);
    @include operations-page-component-theme($theme);
    @include personnel-page-component-theme($theme);
    @include profile-page-component-theme($theme);
    @include recruitment-application-page-component-theme($theme);
    @include recruitment-page-component-theme($theme);
    @include unit-page-component-theme($theme);
    @include units-page-component-theme($theme);

    // Components
    @include admin-servers-component-theme($theme);
    @include admin-variables-component-theme($theme);
    @include comment-display-component-theme($theme);
    @include docs-sidebar-component-theme($theme);
    @include docs-folder-component-theme($theme);
    @include docs-document-component-theme($theme);
    @include docs-content-component-theme($theme);
    @include docs-content-quill-theme($theme);
    @include docs-permissions-component-theme($theme);
    @include file-drop-component-theme($theme);
    @include inline-edit-component-theme($theme);
    @include inline-dropdown-component-theme($theme);
    @include loading-placeholder-component-theme($theme);
    @include selection-list-component-theme($theme);
    @include fft.form-field-theme($theme, 'app-text-input');
    @include fft.form-field-theme($theme, 'app-dropdown');
    @include fft.form-field-theme($theme, 'app-selection-list');
    @include theme-emitter-component-theme($theme);
    @include command-request-component-theme($theme);
    @include command-members-component-theme($theme);
    @include command-member-card-component-theme($theme);
    @include command-ranks-component-theme($theme);
    @include command-roles-component-theme($theme);
    @include command-units-component-theme($theme);
    @include operations-servers-component-theme($theme);
    @include personnel-discharges-component-theme($theme);
    @include personnel-loas-list-component-theme($theme);
    @include personnel-roster-component-theme($theme);
    @include units-orbat-component-theme($theme);
    @include units-orbat-aux-component-theme($theme);
    @include units-orbat-secondary-component-theme($theme);

    // Modals
    @include add-unit-modal-component-theme($theme);
    @include edit-server-mods-modal-component-theme($theme);
    @include request-loa-modal-component-theme($theme);
    @include validation-report-modal-component-theme($theme);
    @include message-modal-component-theme($theme);

    // Modpack
    @include modpack-builds-dev-component-theme($theme);
    @include modpack-builds-rc-component-theme($theme);
    @include modpack-builds-steps-component-theme($theme);
    @include modpack-guide-component-theme($theme);
    @include modpack-releases-component-theme($theme);
    @include modpack-workshop-component-theme($theme);
    @include install-workshop-mod-modal-component-theme($theme);
    @include new-modpack-release-modal-component-theme($theme);
    @include workshop-mod-intervention-modal-component-theme($theme);
}

.dark-theme {
    // Emit --mat-sys-* system-level CSS variables.
    // We do NOT include mat.all-component-themes() because it hardcodes
    // component-level tokens (colors, shapes, typography) from the M3 tonal
    // palette, overriding our --mat-sys-* overrides. Without it, components
    // read directly from --mat-sys-* which we control below.
    @include mat.theme((
        color: (theme-type: dark, primary: mat.$orange-palette),
    ));

    // Emit --uksf-* custom properties
    @include custom-vars.dark-theme-custom-vars();

    // Custom component themes
    @include custom-components-theme($dark-theme);

    // -----------------------------------------------------------------------
    // Override M3 system tokens to match M2 dark theme appearance.
    // M3's tonal palette (from mat.$orange-palette) generates warm-tinted
    // neutrals, large corner radii, and different typography. We override
    // all system-level tokens to restore the original M2 look.
    // -----------------------------------------------------------------------

    // Primary color: exact gold instead of orange tonal value
    & {
        --mat-sys-primary: #fec400;
        --mat-sys-on-primary: #000000;
        --mat-sys-primary-container: #fec400;
        --mat-sys-on-primary-container: #000000;
    }

    // Neutral colors: pure white/gray instead of warm-tinted pinkish values
    & {
        --mat-sys-on-surface: #ffffff;
        --mat-sys-on-surface-variant: rgba(255, 255, 255, 0.7);
        --mat-sys-inverse-surface: #ffffff;
        --mat-sys-inverse-on-surface: rgba(0, 0, 0, 0.87);
        --mat-sys-outline: rgba(255, 255, 255, 0.3);
        --mat-sys-outline-variant: rgba(255, 255, 255, 0.12);
        --mat-sys-surface-variant: #303030;
    }

    // Secondary: neutral instead of warm-tinted
    & {
        --mat-sys-secondary: rgba(255, 255, 255, 0.7);
        --mat-sys-on-secondary: rgba(0, 0, 0, 0.87);
        --mat-sys-secondary-container: #303030;
        --mat-sys-on-secondary-container: #ffffff;
    }

    // Error/warn: standard red instead of M3 light pink
    & {
        --mat-sys-error: #c62828;
        --mat-sys-on-error: #ffffff;
        --mat-sys-error-container: #93000a;
        --mat-sys-on-error-container: #ffdad6;
    }

    // Surface: custom dark palette values
    & {
        --mat-sys-surface: var(--uksf-background);
        --mat-sys-surface-dim: var(--uksf-background);
        --mat-sys-surface-bright: #3f3834;
        --mat-sys-surface-container: var(--uksf-card);
        --mat-sys-surface-container-low: var(--uksf-dark-card);
        --mat-sys-surface-container-high: var(--uksf-hover);
        --mat-sys-surface-container-highest: #545454;
    }

    // Shape: 4px corners everywhere to match M2 (M3 defaults to 8-28px)
    & {
        --mat-sys-corner-extra-small: 4px;
        --mat-sys-corner-small: 4px;
        --mat-sys-corner-medium: 4px;
        --mat-sys-corner-large: 4px;
        --mat-sys-corner-extra-large: 4px;
        --mat-sys-corner-full: 9999px; // keep full-round for chips/badges
    }

    // Typography: restore M2 sizes (M3 defaults are smaller for buttons/labels)
    & {
        --mat-sys-label-large-size: 14px;
        --mat-sys-label-large-weight: 500;
        --mat-sys-label-large-tracking: normal;
        --mat-sys-label-medium-size: 12px;
        --mat-sys-label-small-size: 11px;
        --mat-sys-body-large-size: 14px;
        --mat-sys-body-medium-size: 14px;
        --mat-sys-body-small-size: 12px;
        --mat-sys-title-large-size: 20px;
        --mat-sys-title-medium-size: 16px;
        --mat-sys-title-small-size: 14px;
        --mat-sys-headline-large-size: 32px;
        --mat-sys-headline-medium-size: 28px;
        --mat-sys-headline-small-size: 24px;
    }

    // Button: 4px corners, 36px height, 16px padding (M3 defaults: pill, 40px, 24px)
    & {
        --mat-button-protected-container-shape: 4px;
        --mat-button-protected-container-height: 36px;
        --mat-button-filled-container-shape: 4px;
        --mat-button-filled-container-height: 36px;
        --mat-button-outlined-container-shape: 4px;
        --mat-button-outlined-container-height: 36px;
        --mat-button-text-container-shape: 4px;
        --mat-button-text-container-height: 36px;
    }

    // Button horizontal padding: 16px to match M2 (M3 defaults to 24px)
    .mat-mdc-raised-button,
    .mat-mdc-unelevated-button,
    .mat-mdc-outlined-button {
        padding: 0 16px;
    }

    // Card: 4px corners (M3 defaults to 12px)
    & {
        --mat-card-elevated-container-shape: 4px;
        --mat-card-filled-container-shape: 4px;
        --mat-card-outlined-container-shape: 4px;
    }

    // Dialog: restore M2 defaults (M3 changed max-width from 80vw to 560px,
    // corner radius from 0 to 28px)
    & {
        --mat-dialog-container-shape: 4px;
        --mat-dialog-container-max-width: 80vw;
    }

    // Component container color overrides
    & {
        --mat-card-elevated-container-color: var(--uksf-card);
        --mat-card-outlined-container-color: var(--uksf-card);
        --mat-dialog-container-color: var(--uksf-dialog);
        --mat-menu-container-color: var(--uksf-card);
        --mat-menu-container-shape: 4px;
        --mat-select-panel-background-color: var(--uksf-card);
        --mat-autocomplete-background-color: var(--uksf-card);
        --mat-autocomplete-container-shape: 4px;
        --mat-table-background-color: var(--uksf-card);
        --mat-paginator-container-background-color: var(--uksf-card);
        --mat-expansion-container-background-color: var(--uksf-card);
        --mat-expansion-container-shape: 4px;
        --mat-toolbar-container-background-color: var(--uksf-app-bar);
        --mat-sidenav-content-background-color: var(--uksf-background);
        --mat-app-background-color: var(--uksf-background);
        --mat-stepper-container-color: var(--uksf-card);
        --mat-stepper-container-shape: 4px;
        --mat-select-container-shape: 4px;
        --mat-datepicker-calendar-container-shape: 4px;
        --mat-snack-bar-button-color: #fec400;
    }

    // Form field: label and input text sizing to match custom form fields
    & {
        --mat-form-field-filled-label-text-size: 16px;
        --mat-form-field-outlined-label-text-size: 16px;
        --mat-form-field-container-text-size: 16px;
        --mat-form-field-container-text-weight: 400;
        --mat-form-field-filled-label-text-color: rgba(255, 255, 255, 0.7);
        --mat-form-field-outlined-label-text-color: rgba(255, 255, 255, 0.7);
    }

    // Raised button color variants (not emitted without mat.all-component-themes)
    .mat-mdc-raised-button.mat-primary:not(:disabled) {
        background-color: var(--mat-sys-primary);
        color: var(--mat-sys-on-primary);

        &:hover {
            background-color: color-mix(in srgb, var(--mat-sys-primary) 85%, black);
        }
    }

    .mat-mdc-raised-button.mat-warn:not(:disabled) {
        background-color: var(--mat-sys-error);
        color: var(--mat-sys-on-error);

        &:hover {
            background-color: color-mix(in srgb, var(--mat-sys-error) 85%, black);
        }
    }

    // Default raised button (no color attribute) keeps dark background with white text/hover/ripple
    .mat-mdc-raised-button:not(.mat-primary):not(.mat-warn):not(.mat-accent):not(:disabled) {
        background-color: var(--uksf-raised-button);
        color: white;
        --mat-button-protected-state-layer-color: white;
        --mat-button-protected-ripple-color: rgba(255, 255, 255, 0.12);
    }

    // Flat (unelevated) button color variants
    .mat-mdc-unelevated-button.mat-primary:not(:disabled) {
        background-color: var(--mat-sys-primary);
        color: var(--mat-sys-on-primary);

        &:hover {
            background-color: color-mix(in srgb, var(--mat-sys-primary) 85%, black);
        }
    }

    .mat-mdc-unelevated-button.mat-warn:not(:disabled) {
        background-color: var(--mat-sys-error);
        color: var(--mat-sys-on-error);
    }

    // Disabled raised/flat buttons
    .mat-mdc-raised-button:disabled,
    .mat-mdc-unelevated-button:disabled {
        background-color: rgba(255, 255, 255, 0.12);
        color: rgba(255, 255, 255, 0.5);
    }

    // Icon color variants (not emitted without mat.all-component-themes)
    .mat-icon.mat-primary {
        --mat-icon-color: var(--mat-sys-primary);
    }

    .mat-icon.mat-warn {
        --mat-icon-color: var(--mat-sys-error);
    }

    // Global scrollbar theming
    ::-webkit-scrollbar-track {
        background-color: var(--uksf-side-bar);
    }

    ::-webkit-scrollbar-thumb {
        background-color: var(--uksf-scroll-thumb);
    }

    .mat-impersonated {
        color: #eee !important;
        background-color: #09c900 !important;
    }
    .mat-impersonated[disabled] {
        background-color: rgba(0, 0, 0, 0.12) !important;
    }

    // Tab label colors via M3 tokens (applies to both mat-tab-nav-bar and mat-tab-group)
    & {
        --mat-tab-inactive-label-text-color: rgba(255, 255, 255, 0.6);
        --mat-tab-inactive-hover-label-text-color: rgba(255, 255, 255, 0.6);
        --mat-tab-inactive-focus-label-text-color: rgba(255, 255, 255, 0.6);
        --mat-tab-active-label-text-color: #{th.primary($dark-theme)};
        --mat-tab-active-hover-label-text-color: #{th.primary($dark-theme)};
        --mat-tab-active-focus-label-text-color: #{th.primary($dark-theme)};
        --mat-tab-active-indicator-color: #{th.primary($dark-theme)};
        --mat-tab-label-text-weight: 500;
    }

    .nav-bar {
        display: block;
        padding: 0 0 12px 0;

        // Remove duplicate border — .mat-mdc-tab-nav-bar already has one
        .mat-mdc-tab-link-container {
            border-bottom: none;
        }

        .mat-mdc-tab-link {
            background-color: var(--uksf-background);

            // Remove focus ring/outline on click
            .mdc-tab__ripple::before {
                background-color: transparent;
            }

            &:focus {
                outline: none;
            }

            .mat-mdc-focus-indicator::before {
                border: none;
            }

            &:hover {
                background-color: var(--uksf-hover);
            }
        }
    }

    b {
        filter: blur(0px);
    }

    .mat-mdc-button {
        background-color: var(--uksf-selected);
    }

    input {
        color: th.fg-base($dark-theme) !important;
        background-color: transparent !important;
    }

    .mat-expansion-indicator::after {
        transform: rotate(45deg) translate(-2px, -2px);
    }

    .mat-mdc-tab-nav-bar {
        overflow: auto;
        border-bottom: 1px solid rgba(255, 255, 255, .12);
    }

    // Form field: remove filled background and focus overlay for underline-only appearance
    @include mffo.form-field-underline($dark-theme);

    .mat-mdc-form-field.mat-form-field-appearance-fill {
        .mat-mdc-form-field-infix {
            min-height: 40px;
            padding-top: 20px;
            padding-bottom: 0;
        }

        .mat-mdc-form-field-subscript-wrapper {
            padding: 0;
        }

        .mat-mdc-form-field-error-wrapper {
            padding: 0;
        }

        // Datepicker fields: match custom form field height
        // (40px input + 4px gap + 16px error = 60px total)
        &.datepicker-field {
            .mat-mdc-form-field-infix {
                min-height: 40px;
                max-height: 40px;
            }

            .mat-mdc-form-field-subscript-wrapper {
                padding: 0;
                margin-top: 4px;
                min-height: 16px;
                overflow: hidden;
            }

            .mat-mdc-form-field-error-wrapper {
                padding: 0;
            }

            mat-error {
                font-size: 11px;
                line-height: 16px;
                height: 16px;
            }
        }
    }

    // Hide MDC checkmark on single-select mat-option (MDC adds it by default, legacy did not)
    .mat-mdc-option .mat-pseudo-checkbox {
        display: none;
    }

    .mat-mdc-button-touch-target {
        display: none !important;
    }
}

// MDC card: remove default border, restore legacy shadow and 16px padding
.mat-mdc-card {
    border: none;
    padding: 16px;
    box-shadow: 0 2px 1px -1px rgba(0, 0, 0, 0.2),
                0 1px 1px 0 rgba(0, 0, 0, 0.14),
                0 1px 3px 0 rgba(0, 0, 0, 0.12);

    .mat-mdc-card-content {
        padding: 0 16px;

        &:first-child {
            padding-top: 16px;
        }

        &:last-child {
            padding-bottom: 16px;
        }
    }
}

// MDC button: restore legacy 36px height, flex-center content
.mat-mdc-button,
.mat-mdc-raised-button,
.mat-mdc-outlined-button,
.mat-mdc-unelevated-button {
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

// MDC icon-button: restore legacy 40px sizing with 24px icon
.mat-mdc-icon-button {
    width: 40px !important;
    height: 40px !important;
    padding: 8px !important;

    .mat-icon {
        font-size: 24px !important;
        width: 24px !important;
        height: 24px !important;
        line-height: 24px !important;
    }
}

// MDC flat/raised buttons: restore 24px icons (Material 17 sets 1.125rem)
// Double-class selector (0,3,0 specificity) beats Material's > child selector
// (0,2,0) while still letting component-scoped rules with higher specificity win.
// margin: 0 resets Material 17's default margin-right: 8px on icons, which
// mis-aligns icon-only buttons. Icon+text buttons handle spacing via their own CSS.
.mat-mdc-button.mat-mdc-button-base .mat-icon,
.mat-mdc-raised-button.mat-mdc-button-base .mat-icon,
.mat-mdc-outlined-button.mat-mdc-button-base .mat-icon,
.mat-mdc-unelevated-button.mat-mdc-button-base .mat-icon {
    font-size: 24px;
    width: 24px;
    height: 24px;
    line-height: 24px;
    margin: 0;
}

// MDC tab nav bar: don't stretch tabs to fill width
.mat-mdc-tab-link,
.mat-mdc-tab {
    flex-grow: 0 !important;
    min-width: 160px !important;
}


// MDC tab nav panel: flex to fill available space (for AAR iframe etc.)
mat-tab-nav-panel,
.mat-mdc-tab-nav-panel {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-height: 0;
}


// ---------------------------------------------------------------------------
// CDK drag preview
// ---------------------------------------------------------------------------
// CDK drag previews are cloned DOM nodes appended to <body>, outside
// .dark-theme. They don't inherit --mat-sys-* or --uksf-* variables.
// We set explicit tokens, form field underline, button styles, and
// layout mixins. Themed colors handled by component scss-theme files
// via @at-root .cdk-drag-preview.
.cdk-drag-preview {
    // Emit --uksf-* custom properties (not inherited from .dark-theme)
    @include custom-vars.dark-theme-custom-vars();

    // Card and form field tokens needed for drag previews.
    // We set these explicitly instead of using mat.card-theme()/mat.form-field-theme()
    // because those would emit M3 tonal palette values (warm-tinted colors).
    --mat-card-elevated-container-shape: 4px;
    --mat-card-elevated-container-color: var(--uksf-card);

    box-sizing: border-box;
    overflow: hidden;

    // --- Form field: underline-only appearance (mirrors .dark-theme overrides) ---
    @include mffo.form-field-underline($dark-theme);

    // Custom form field (app-text-input, app-dropdown): set theme CSS variables
    // that are normally scoped to .dark-theme selectors
    @include fft.form-field-theme($dark-theme, 'app-text-input');
    @include fft.form-field-theme($dark-theme, 'app-dropdown');

    input {
        color: th.fg-base($dark-theme) !important;
        background-color: transparent !important;
    }

    // --- Button: explicit styles (JS chunk component styles don't cascade) ---
    .mat-mdc-raised-button {
        border-radius: 4px;
        height: 36px;
    }

    .mat-mdc-raised-button.mat-primary:not(:disabled) {
        background-color: th.primary($dark-theme);
        color: th.primary-contrast($dark-theme);
    }

    .mat-mdc-raised-button:disabled {
        background-color: th.fg-divider($dark-theme);
        color: th.fg-disabled-text($dark-theme);
    }

    // --- Ranks list item layout ---
    .ranks-list-item {
        @include ranks-layout.ranks-list-item-layout;
        font-size: 16px;
    }

    // --- Servers list item layout ---
    // margin: 0 prevents bottom clipping (CDK sizes the preview from
    // getBoundingClientRect which excludes margin)
    .servers-list-item {
        @include servers-layout.servers-list-item-layout;
        margin: 0 !important;

        .icon {
            line-height: 36px;
            height: 36px;
            padding: 0;
            min-width: 36px;
            align-self: center;
        }

        .mat-mdc-raised-button {
            margin-right: 5px;
            flex-shrink: 0;
            padding: 0 16px;
        }

        .mission-select {
            width: 450px !important;
            margin: 0 10px;
            align-self: center;

            .mat-mdc-form-field-infix {
                min-height: unset;
                padding-top: 8px !important;
                padding-bottom: 8px !important;
            }

            .mat-mdc-form-field-subscript-wrapper {
                display: none;
            }
        }
    }
}

// ---------------------------------------------------------------------------
// Spotlight hover effect (Fluent Design Reveal Highlight)
// ---------------------------------------------------------------------------
.spotlight-active {
    position: relative;
    overflow: hidden;

    &::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: radial-gradient(
            circle var(--spotlight-size, 200px) at var(--spotlight-x, 50%) var(--spotlight-y, 50%),
            var(--spotlight-color, rgba(255, 255, 255, 0.08)),
            var(--spotlight-color, rgba(255, 255, 255, 0.08)) 30%,
            transparent 100%
        );
        pointer-events: none;
        z-index: 1;
    }
}

// ---------------------------------------------------------------------------
// Global scrollbar sizing
// ---------------------------------------------------------------------------
// Uniform 9px scrollbar across the site. Theme colors applied in .dark-theme.
::-webkit-scrollbar {
    width: 9px;
    height: 9px;
}

::-webkit-scrollbar-track {
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    border-radius: 4px;
}

// ---------------------------------------------------------------------------
// Page layout utilities
// ---------------------------------------------------------------------------
.page-container {
    padding: 0 16px 16px;
}

// Mat-paginator: remove outlined border from the "items per page" select
mat-paginator .mdc-notched-outline__leading,
mat-paginator .mdc-notched-outline__notch,
mat-paginator .mdc-notched-outline__trailing {
    border: none !important;
}

// ---------------------------------------------------------------------------
// Unified modal layout
// ---------------------------------------------------------------------------
// All modals use: <h2 mat-dialog-title>, <mat-dialog-content>, <mat-dialog-actions>
// These global rules handle spacing, scrolling, and button layout.

.mat-mdc-dialog-container {
    --mat-dialog-supporting-text-color: white;
    // M3 line-height falls back to 1.5rem which resolves to 15px (root font-size is 10px
    // from _bootstrap-reset.scss). Use unitless 1.5 so it scales with each element's font-size.
    --mat-dialog-supporting-text-line-height: 1.5;
}

.mat-mdc-dialog-title {
    margin: 0 !important;
    padding: 16px 0 12px !important;
}

.mat-mdc-dialog-container .mat-mdc-dialog-title {
    padding: 16px 24px 12px !important;
}

mat-dialog-content, .mat-mdc-dialog-content {
    padding: 0 24px !important;
    max-height: 70vh;
    overflow-y: auto;
    form {
        display: flex;
        flex-direction: column;
    }
}

.overflow-hidden-dialog .mat-mdc-dialog-content {
    overflow: hidden;
}

.no-max-height-dialog .mat-mdc-dialog-content {
    max-height: none;
}

mat-dialog-actions, .mat-mdc-dialog-actions {
    padding: 12px 24px 16px !important;
    margin: 0 !important;
    min-height: unset !important;
    display: flex !important;
    flex-direction: row !important;
    justify-content: flex-end !important;
    gap: 8px;
    color: white; // CDK overlay renders outside .dark-theme — no theme cascade
}

// MDC checkbox: allow label text to wrap
.mat-mdc-checkbox label {
    white-space: normal !important;
}

.cdk-virtual-scroll-orientation-horizontal {
    .cdk-virtual-scroll-content-wrapper {
        display: flex;
        flex-direction: row;
    }
}

.variables-list {
    .mat-expansion-panel-body {
        padding: 0 0 0 24px;
    }
}

.mods-list-item-container,
.trainings-list-item-container,
.pbos-list-item-container,
.stats-item {
    .mat-mdc-checkbox {
        margin-bottom: 0;
    }
}

.mat-mdc-checkbox {
    --mat-checkbox-touch-target-size: 40px;
    margin: 0;

    label {
        margin: 0;
        color: white; // CDK overlay renders outside .dark-theme — no theme cascade
        font-size: 14px;
        line-height: 20px;
        padding-left: 8px !important;
    }
}

// Reset MDC typography overrides to match legacy Material
.mat-mdc-button,
.mat-mdc-raised-button,
.mat-mdc-icon-button,
.mat-mdc-outlined-button,
.mat-mdc-unelevated-button,
.mat-mdc-fab,
.mat-mdc-mini-fab {
    letter-spacing: normal;

    .mdc-button__label {
        letter-spacing: normal;
    }
}

.mat-mdc-tab,
.mat-mdc-tab-link {
    letter-spacing: normal;
    min-width: 72px;

    .mdc-tab__text-label {
        letter-spacing: normal;
    }
}

.mdc-tab.mat-mdc-tab,
.mdc-tab.mat-mdc-tab-link {
    padding: 0 16px;
}

// Autocomplete panel: when using virtual scroll, hide the outer scrollbar
.mat-mdc-autocomplete-panel {
    max-height: 456px !important;

    &:has(cdk-virtual-scroll-viewport) {
        overflow: hidden !important;
    }
}

@media screen and (max-height: 800px) {
    .mat-mdc-autocomplete-panel {
        max-height: 312px !important;
    }
}

@media screen and (max-height: 700px) {
    .mat-mdc-autocomplete-panel {
        max-height: 264px !important;
    }
}
